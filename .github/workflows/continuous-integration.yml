# @format

name: Continuous Integration
on:
     push:
          branches:
               - main
     pull_request:
          types: [opened, synchronize, reopened, ready_for_review]

jobs:
     build_web:
          runs-on: ubuntu-latest
          steps:
               - name: Checkout repository
                 uses: actions/checkout@v6

               - uses: pnpm/action-setup@v4
                 name: Install pnpm
                 with:
                      version: 10
                      run_install: false

               - name: Get pnpm store directory
                 shell: bash
                 run: |
                      echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

               - uses: actions/cache@v5
                 name: Setup pnpm cache
                 with:
                      path: ${{ env.STORE_PATH }}
                      key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                      restore-keys: |
                           ${{ runner.os }}-pnpm-store-

               - name: Sync node version and setup cache
                 uses: actions/setup-node@v6
                 with:
                      node-version: "lts/*"
                      cache: "pnpm"

               - name: Install dependencies
                 run: pnpm install --no-frozen-lockfile

               # - name: Lint
               #   run: pnpm run lint

               - name: Build
                 run: pnpm run build

     build:
          needs: build_web
          # Prevent forked PRs from running the build job which is expensive
          if: github.repository == 'prayag17/Blink'
          strategy:
               fail-fast: false
               matrix:
                    platform: [macos-latest, ubuntu-22.04, windows-latest]
          runs-on: ${{ matrix.platform }}
          environment: TAURI
          steps:
               - name: Checkout repository
                 uses: actions/checkout@v6

               - name: Install dependencies (ubuntu only)
                 if: matrix.platform == 'ubuntu-22.04'
                 # You can remove libayatana-appindicator3-dev if you don't use the system tray feature.
                 run: |
                      sudo apt-get update
                      sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev librsvg2-dev

               - name: Rust setup
                 uses: dtolnay/rust-toolchain@stable

               - name: Rust cache
                 uses: swatinem/rust-cache@v2
                 with:
                      workspaces: "./src-tauri -> target"

               - uses: pnpm/action-setup@v4
                 name: Install pnpm
                 with:
                      version: 10
                      run_install: false

               - name: Get pnpm store directory
                 shell: bash
                 run: |
                      echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

               - uses: actions/cache@v5
                 name: Setup pnpm cache
                 with:
                      path: ${{ env.STORE_PATH }}
                      key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                      restore-keys: |
                           ${{ runner.os }}-pnpm-store-

               - name: Sync node version and setup cache
                 uses: actions/setup-node@v6
                 with:
                      node-version: "lts/*"
                      cache: "pnpm"

               - name: Install dependencies
                 run: pnpm install --no-frozen-lockfile

               - name: Build app
                 run: pnpm run tauri build --debug
                 env:
                      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                      TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
                      TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
                      TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
                      TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

                      # TODO: Remove the below command after upstream issue is fixed
                      # Related issue: https://github.com/tauri-apps/tauri/issues/10702
                      WEBKIT_DISABLE_DMABUF_RENDERER: 1 # Disable DMABUF renderer on Wayland

               - name: Upload build Artifacts
                 uses: actions/upload-artifact@v6
                 with:
                      name: Blink-${{ matrix.platform }}-dev${{ github.sha }}
                      path: src-tauri/target/debug/bundle/*

     # Create or update nightly release
     nightly_release:
          needs: build
          if: github.repository == 'prayag17/Blink' && github.event_name == 'push' && github.ref == 'refs/heads/main'
          runs-on: ubuntu-latest
          permissions:
               contents: write     # Required for creating/updating releases
          steps:
               - name: Checkout repository
                 uses: actions/checkout@v6.0.1

               - name: Download all artifacts
                 uses: actions/download-artifact@v7.0.0
                 with:
                    path: artifacts
                    
               - name: Prepare assets
                 run: |
                   mkdir -p release_assets
                   find artifacts -type f \( -name "*.exe" -o -name "*.msi" -o -name "*.dmg" -o -name "*.deb" -o -name "*.AppImage" -o -name "*.rpm" -o -name "*.tar.gz" \) | while read -r file; do
                     # Extract platform from artifact name (e.g. Blink-ubuntu-22.04-devSHA)
                     artifact_name=$(echo "$file" | cut -d'/' -f2)
                     platform=$(echo "$artifact_name" | sed -E 's/Blink-(.*)-dev.*/\1/' | sed 's/-/_/g')
                     filename=$(basename "$file")
                     cp "$file" "release_assets/${platform}-${filename}"
                   done

               - name: Delete old nightly release
                 run: gh release delete nightly --yes --repo ${{ github.repository }} || true
                 env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

               - name: Create nightly release
                 uses: softprops/action-gh-release@v2.5.0
                 with:
                    tag_name: nightly
                    name: Nightly Build (${{ github.sha }})
                    body: |
                      Nightly build from the latest main branch.
                      
                      **Last commit:** ${{ github.event.head_commit.message }}
                      **SHA:** ${{ github.sha }}
                    prerelease: true
                    files: release_assets/*
                    fail_on_unmatched_files: true

